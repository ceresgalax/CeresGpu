<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <ItemGroup>
        <GlslVertFile Include="**\*.vert.glsl">
            <GgenVersionFile>%(RecursiveDir)%(Filename).ggen_version</GgenVersionFile>
            <CsFile>%(RecursiveDir)$([System.IO.Path]::GetFileNameWithoutExtension('%(Filename)')).Generated.cs</CsFile>
            <LogicalDirectory>$(MSBuildProjectName).$([System.String]::new('%(RecursiveDir)').Replace('/', '.'))</LogicalDirectory>
        </GlslVertFile>
        <GlslFragFile Include="**\*.frag.glsl">
            <GgenVersionFile>%(RecursiveDir)%(Filename).ggen_version</GgenVersionFile>
            <LogicalDirectory>$(MSBuildProjectName).$([System.String]::new('%(RecursiveDir)').Replace('/', '.'))</LogicalDirectory>
        </GlslFragFile>
    </ItemGroup>
    
    <ItemGroup>
        <GgenScript Include="$(MSBuildThisFileDirectory)\ggen\**\*.py">
            <Link>%(RelativeDir)/%(Filename).%(Extension)</Link>
        </GgenScript>
    </ItemGroup>
    
    <ItemGroup>
        <Compile Include="@(GlslVertFile -> '$(IntermediateOutputPath)ggen/%(CsFile)')">
            <Link>%(CsFile)</Link>
        </Compile>
        
        <EmbeddedResource Include="@(GlslVertFile -> '$(IntermediateOutputPath)ggen/%(RecursiveDir)/%(Filename).spv')">
            <LogicalName>%(LogicalDirectory)%(Filename).spv</LogicalName>
        </EmbeddedResource>
        <EmbeddedResource Include="@(GlslVertFile -> '$(IntermediateOutputPath)ggen/%(RecursiveDir)/%(Filename)_gl.spv')">
            <LogicalName>%(LogicalDirectory)%(Filename)_gl.spv</LogicalName>
        </EmbeddedResource>
        <EmbeddedResource Include="@(GlslVertFile -> '$(IntermediateOutputPath)ggen/%(RecursiveDir)/%(Filename).metal')">
            <LogicalName>%(LogicalDirectory)%(Filename).metal</LogicalName>
        </EmbeddedResource>

        <EmbeddedResource Include="@(GlslFragFile -> '$(IntermediateOutputPath)ggen/%(RecursiveDir)/%(Filename).spv')">
            <LogicalName>%(LogicalDirectory)%(Filename).spv</LogicalName>
        </EmbeddedResource>
        <EmbeddedResource Include="@(GlslFragFile -> '$(IntermediateOutputPath)ggen/%(RecursiveDir)/%(Filename)_gl.spv')">
            <LogicalName>%(LogicalDirectory)%(Filename)_gl.spv</LogicalName>
        </EmbeddedResource>
        <EmbeddedResource Include="@(GlslFragFile -> '$(IntermediateOutputPath)ggen/%(RecursiveDir)/%(Filename).metal')">
            <LogicalName>%(LogicalDirectory)%(Filename).metal</LogicalName>
        </EmbeddedResource>
    </ItemGroup>
    
    <Target Name="ggen" BeforeTargets="Build;BeforeBuild;DispatchToInnerBuilds">
        <Message Importance="high" Text="Running ggen..." />
        <Exec
            WorkingDirectory="$(MSBuildThisFileDirectory)"
            Command="python3 -m ggen &quot;$(MSBuildProjectDirectory)&quot; --ggen-script-files &quot;@(GgenScript)&quot; --files &quot;@(GlslVertFile -> '%(FullPath)');@(GlslFragFile -> '%(FullPath)')&quot; --output-dir &quot;$(MSBuildProjectDirectory)/$(IntermediateOutputPath)ggen&quot;" 
        />
        <ItemGroup>
            <FileWrites Include="@(GlslVertFile -> '$(IntermediateOutputPath)ggen/%(CsFile)')" />
            <FileWrites Include="@(GlslVertFile -> '$(IntermediateOutputPath)ggen/%(RelativeDir)%(Filename).spv')" />
            <FileWrites Include="@(GlslFragFile -> '$(IntermediateOutputPath)ggen/%(RelativeDir)%(Filename).spv')" />
            <FileWrites Include="@(GlslVertFile -> '$(IntermediateOutputPath)ggen/%(RelativeDir)%(Filename).reflection.json')" />
            <FileWrites Include="@(GlslFragFile -> '$(IntermediateOutputPath)ggen/%(RelativeDir)%(Filename).reflection.json')" />
            <FileWrites Include="@(GlslVertFile -> '$(IntermediateOutputPath)ggen/%(RelativeDir)%(Filename)_gl.spv')" />
            <FileWrites Include="@(GlslFragFile -> '$(IntermediateOutputPath)ggen/%(RelativeDir)%(Filename)_gl.spv')" />
            <FileWrites Include="@(GlslVertFile -> '$(IntermediateOutputPath)ggen/%(RelativeDir)%(Filename).metal')" />
            <FileWrites Include="@(GlslFragFile -> '$(IntermediateOutputPath)ggen/%(RelativeDir)%(Filename).metal')" />
        </ItemGroup>
    </Target>
    
</Project>